<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T & L | Admin - Gerenciamento</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rye&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* --- CSS GLOBAL --- */
        body {
            background-color: #0f0f0f;
            background-image: repeating-linear-gradient(45deg, #0f0f0f, #0f0f0f 10px, #1a1a1a 10px, #1a1a1a 20px);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            font-family: 'Roboto Slab', serif;
        }

        /* --- NAVBAR ADMIN --- */
        .navbar-custom {
            background-color: rgba(15, 15, 15, 0.95);
            border-bottom: 2px solid #FFD700;
            padding: 15px 0;
            font-family: 'Rye', serif;
        }
        .navbar-brand { font-size: 1.5rem; color: #FFD700 !important; }
        .nav-link { color: white !important; font-size: 1.1rem; margin: 0 10px; transition: color 0.3s; }
        .nav-link:hover { color: #FFD700 !important; }
        .admin-badge {
            background-color: #FFD700;
            color: black;
            padding: 2px 8px;
            border-radius: 5px;
            font-size: 0.8rem;
            vertical-align: middle;
            margin-left: 10px;
        }

        /* --- LAYOUT DO PAINEL --- */
        .page-title {
            font-family: 'Rye', serif;
            color: #FFD700;
            font-size: 2.5rem;
            text-align: center;
            margin: 30px 0;
        }

        /* Abas de Navegação */
        .nav-tabs { border-bottom: 2px solid #FFD700; }
        .nav-tabs .nav-link {
            color: #ccc;
            font-family: 'Rye', serif;
            border: none;
            font-size: 1.2rem;
        }
        .nav-tabs .nav-link.active {
            background-color: #FFD700;
            color: black !important;
            border-radius: 10px 10px 0 0;
        }
        .tab-content {
            background-color: rgba(20, 20, 20, 0.9);
            border: 1px solid #FFD700;
            border-top: none;
            border-radius: 0 0 20px 20px;
            padding: 30px;
            min-height: 500px;
        }

        /* --- CALENDÁRIO DINÂMICO --- */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            color: #FFD700;
            font-family: 'Rye', serif;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            text-align: center;
        }
        .day-name { color: #888; font-weight: bold; margin-bottom: 10px; }
        
        .calendar-day {
            background-color: #1a1a1a;
            border: 1px solid #444;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            min-height: 60px; /* Altura mínima para ficar bonito */
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .calendar-day:hover { border-color: #FFD700; background-color: #252525; }
        
        /* Dia Selecionado */
        .calendar-day.active { background-color: #FFD700; color: black; border-color: #FFD700; transform: scale(1.05); }
        
        /* Dia com Evento (Bolinha Vermelha) */
        .calendar-day.has-event::after {
            content: '';
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 8px;
            background-color: #ff4444; /* Vermelho vivo */
            border-radius: 50%;
            box-shadow: 0 0 5px #ff4444;
        }
        
        /* Dias passados ou de outro mês */
        .calendar-day.other-month { opacity: 0.3; pointer-events: none; }

        /* --- CARDS DE AGENDAMENTO DA LISTA --- */
        .appointment-card {
            background-color: #252525;
            border-left: 5px solid #FFD700;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: 0.3s;
        }
        .appointment-card:hover { background-color: #333; }
        
        .client-info h5 { color: #FFD700; margin: 0; font-family: 'Rye', serif; font-size: 1.2rem; }
        .client-info p { margin: 5px 0 0; color: #ccc; font-size: 0.9rem; }
        .client-contact { font-size: 0.8rem; color: #888; font-style: italic; }

        .btn-action {
            border: 1px solid white;
            color: white;
            background: transparent;
            border-radius: 5px;
            padding: 5px 10px;
            margin-left: 5px;
            transition: 0.3s;
        }
        .btn-action:hover { background-color: #FFD700; color: black; border-color: #FFD700; }
        .btn-delete:hover { background-color: #ff4444; border-color: #ff4444; color: white; }

        /* --- FORMULÁRIOS E GERAIS --- */
        .admin-input {
            background-color: #1a1a1a;
            border: 1px solid #FFD700;
            border-radius: 12px;
            color: white;
            padding: 10px;
            width: 100%;
            margin-bottom: 15px;
        }
        .admin-btn {
            background-color: #FFD700;
            color: black;
            font-family: 'Rye', serif;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            width: 100%;
            transition: 0.3s;
        }
        .admin-btn:hover { transform: scale(1.02); box-shadow: 0 0 10px rgba(255,215,0,0.5); }
        .admin-btn-secondary { background-color: transparent; border: 1px solid #FFD700; color: #FFD700; margin-top: 10px; }
        .admin-btn-secondary:hover { background-color: #FFD700; color: black; }

        .service-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444; padding: 15px 0; }
        .service-img-tag { font-size: 0.8rem; color: #aaa; margin-left: 10px; font-style: italic; }

        .footer { background-color: rgba(15,15,15,0.95); border-top: 2px solid #FFD700; padding: 20px 0; margin-top: auto; }
        .footer-item { display: flex; align-items: center; justify-content: center; gap: 10px; color: #fff; font-size: 14px; }
        .footer-item i { color: #FFD700; font-size: 18px; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-custom">
        <div class="container">
            <a class="navbar-brand" href="#">T & L Admin <span class="admin-badge">Painel</span></a>
            <button class="navbar-toggler bg-warning" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="index.html">Voltar aos Serviços</a></li>
                    <li class="nav-item"><a class="nav-link" href="#">Sair <i class="fas fa-sign-out-alt"></i></a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container flex-grow-content pb-5">
        <h1 class="page-title"><i class="fas fa-tools"></i> Gerenciamento</h1>

        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item"><a class="nav-link active" id="agenda-tab" data-bs-toggle="tab" data-bs-target="#agenda" type="button">
                <i class="far fa-calendar-alt"></i> Agenda
            </a></li>
            <li class="nav-item"><a class="nav-link" id="servicos-tab" data-bs-toggle="tab" data-bs-target="#servicos" type="button">
                <i class="fas fa-cut"></i> Serviços
            </a></li>
            <li class="nav-item"><a class="nav-link" id="horarios-tab" data-bs-toggle="tab" data-bs-target="#horarios" type="button">
                <i class="far fa-clock"></i> Horários
            </a></li>
        </ul>

        <div class="tab-content" id="myTabContent">
            
            <div class="tab-pane fade show active" id="agenda" role="tabpanel">
                <div class="calendar-header">
                    <button class="btn btn-outline-warning btn-sm" onclick="mudarMes(-1)"><i class="fas fa-chevron-left"></i></button>
                    <h3 id="mesAnoTitulo">Carregando...</h3>
                    <button class="btn btn-outline-warning btn-sm" onclick="mudarMes(1)"><i class="fas fa-chevron-right"></i></button>
                </div>

                <div class="calendar-grid mb-4">
                    <div class="day-name">DOM</div><div class="day-name">SEG</div><div class="day-name">TER</div>
                    <div class="day-name">QUA</div><div class="day-name">QUI</div><div class="day-name">SEX</div><div class="day-name">SÁB</div>
                </div>
                <div id="diasCalendario" class="calendar-grid mb-4">
                    </div>

                <hr class="border-warning my-4">

                <h4 class="text-warning mb-3 font-monospace" id="tituloListaAgendamentos">Selecione um dia</h4>
                
                <div id="listaAgendamentosAdmin">
                    <p class="text-muted text-center py-3">Clique em um dia no calendário para ver os horários.</p>
                </div>
            </div>

            <div class="tab-pane fade" id="servicos" role="tabpanel">
                <div class="row">
                    <div class="col-md-5 mb-4">
                        <h4 class="text-warning mb-3">Novo Serviço</h4>
                        <form id="formServico">
                            <label class="text-secondary">Nome do Corte/Serviço</label>
                            <input type="text" id="inputNome" class="admin-input" placeholder="Ex: Platinado" required>
                            <label class="text-secondary">Preço (R$)</label>
                            <input type="number" id="inputPreco" class="admin-input" placeholder="0.00" step="0.01" required>
                            <label class="text-secondary">Foto do Serviço (Upload)</label>
                            <input type="file" id="inputImagem" class="admin-input" accept="image/*">
                            <small class="text-muted d-block mb-3" style="font-size: 0.8rem;">*Escolha uma imagem leve.</small>
                            <button type="submit" class="admin-btn">Adicionar Serviço</button>
                        </form>
                        <hr class="border-warning my-4">
                        <div class="alert alert-secondary text-center">
                            <small>Preencha automaticamente os preços padrão.</small>
                            <button onclick="carregarPadroes()" class="admin-btn admin-btn-secondary mt-2">Restaurar Padrões</button>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <h4 class="text-warning mb-3">Serviços Ativos</h4>
                        <div id="lista-servicos-admin">
                            <p class="text-center text-secondary mt-5">Nenhum serviço cadastrado.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="horarios" role="tabpanel">
                <h4 class="text-warning mb-4">Configurar Funcionamento</h4>
                <div class="row">
                    <div class="col-md-6"><label class="text-secondary">Abertura</label><input type="time" id="adminAbertura" class="admin-input" value="08:00"></div>
                    <div class="col-md-6"><label class="text-secondary">Fechamento</label><input type="time" id="adminFechamento" class="admin-input" value="19:00"></div>
                    <div class="col-md-6"><label class="text-secondary">Início Almoço</label><input type="time" id="adminAlmocoInicio" class="admin-input" value="12:00"></div>
                    <div class="col-md-6"><label class="text-secondary">Fim Almoço</label><input type="time" id="adminAlmocoFim" class="admin-input" value="14:00"></div>
                    <div class="col-12 mt-3"><button class="admin-btn" onclick="salvarHorarios()">Salvar Alterações</button></div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container"><div class="row text-center"><div class="col-12"><div class="footer-item"><i class="fas fa-lock"></i><span>Área Administrativa Restrita - T & L BarberShop</span></div></div></div></div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // --- VARIÁVEIS GLOBAIS DA AGENDA ---
        let dataAtual = new Date();
        let mesAtual = dataAtual.getMonth();
        let anoAtual = dataAtual.getFullYear();

        // --- 1. LÓGICA DO CALENDÁRIO REAL ---
        function renderizarCalendario() {
            const containerDias = document.getElementById('diasCalendario');
            const tituloMes = document.getElementById('mesAnoTitulo');
            
            // Nomes dos meses
            const meses = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            tituloMes.innerText = `${meses[mesAtual]} ${anoAtual}`;
            
            containerDias.innerHTML = '';

            // Dados para cálculo do grid
            const primeiroDiaDoMes = new Date(anoAtual, mesAtual, 1).getDay(); // 0 = Domingo
            const diasNoMes = new Date(anoAtual, mesAtual + 1, 0).getDate();
            
            // Busca agendamentos do banco para marcar bolinhas
            const todosAgendamentos = JSON.parse(localStorage.getItem('meusAgendamentos')) || [];

            // Cria dias em branco antes do dia 1
            for (let i = 0; i < primeiroDiaDoMes; i++) {
                const vazio = document.createElement('div');
                vazio.className = 'calendar-day other-month';
                containerDias.appendChild(vazio);
            }

            // Cria os dias reais (1 a 31)
            for (let dia = 1; dia <= diasNoMes; dia++) {
                const divDia = document.createElement('div');
                divDia.className = 'calendar-day';
                divDia.innerText = dia;

                // Formata a data para comparar com o banco (formato yyyy-mm-dd)
                // O mês em JS começa em 0, então somamos 1. PadStart coloca o zero na frente (ex: 01, 02)
                const dataFormatadaISO = `${anoAtual}-${String(mesAtual + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;

                // Verifica se tem agendamento neste dia
                const temAgendamento = todosAgendamentos.some(ag => ag.data === dataFormatadaISO);
                if (temAgendamento) {
                    divDia.classList.add('has-event');
                }

                // Evento de Clique no Dia
                divDia.onclick = function() {
                    // Remove ativo dos outros
                    document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Mostra lista
                    listarAgendamentosDoDia(dataFormatadaISO, dia);
                };

                containerDias.appendChild(divDia);
            }
        }

        function mudarMes(direcao) {
            mesAtual += direcao;
            if (mesAtual < 0) {
                mesAtual = 11;
                anoAtual--;
            } else if (mesAtual > 11) {
                mesAtual = 0;
                anoAtual++;
            }
            renderizarCalendario();
        }

        function listarAgendamentosDoDia(dataISO, diaNumero) {
            const containerLista = document.getElementById('listaAgendamentosAdmin');
            const titulo = document.getElementById('tituloListaAgendamentos');
            
            // Atualiza título
            const meses = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
            titulo.innerHTML = `Agendamentos para ${diaNumero}/${meses[mesAtual]}`; // Ex: 30/Jan

            // Busca e Filtra
            const todosAgendamentos = JSON.parse(localStorage.getItem('meusAgendamentos')) || [];
            
            // Filtra pela data clicada
            const agendamentosDoDia = todosAgendamentos.filter(ag => ag.data === dataISO);
            
            // Ordena por horário
            agendamentosDoDia.sort((a, b) => a.hora.localeCompare(b.hora));

            containerLista.innerHTML = '';

            if (agendamentosDoDia.length === 0) {
                containerLista.innerHTML = '<p class="text-muted text-center py-4">Nenhum horário marcado para este dia.</p>';
                return;
            }

            // Cria os Cards
            agendamentosDoDia.forEach(ag => {
                const div = document.createElement('div');
                div.className = 'appointment-card';
                div.innerHTML = `
                    <div class="client-info">
                        <h5>${ag.cliente}</h5>
                        <p><i class="fas fa-cut text-warning"></i> ${ag.servico} | <i class="far fa-clock text-warning"></i> ${ag.hora}</p>
                        <div class="client-contact mt-1">
                            <i class="fab fa-whatsapp"></i> ${ag.whatsapp} | CPF: ${ag.cpf}
                        </div>
                    </div>
                    <div>
                        <button class="btn-action" title="Editar (Em breve)"><i class="fas fa-pen"></i></button>
                        <button class="btn-action btn-delete" onclick="deletarAgendamentoAdmin(${ag.id})" title="Cancelar"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                containerLista.appendChild(div);
            });
        }

        // Função para cancelar agendamento pelo Admin
        function deletarAgendamentoAdmin(id) {
            if(confirm("Deseja cancelar este agendamento do sistema?")) {
                let todosAgendamentos = JSON.parse(localStorage.getItem('meusAgendamentos')) || [];
                todosAgendamentos = todosAgendamentos.filter(ag => ag.id !== id);
                localStorage.setItem('meusAgendamentos', JSON.stringify(todosAgendamentos));
                
                alert("Agendamento cancelado!");
                // Recarrega o calendário para atualizar bolinhas e lista
                renderizarCalendario();
                document.getElementById('listaAgendamentosAdmin').innerHTML = '<p class="text-muted text-center">Selecione o dia novamente.</p>';
            }
        }

        // --- 2. GERENCIAMENTO DE SERVIÇOS E UPLOAD (Código anterior) ---
        let imagemConvertidaBase64 = ""; 

        document.getElementById('inputImagem').addEventListener('change', function(event) {
            const arquivo = event.target.files[0];
            if (arquivo) {
                const leitor = new FileReader();
                leitor.onload = function(e) { imagemConvertidaBase64 = e.target.result; };
                leitor.readAsDataURL(arquivo); 
            } else { imagemConvertidaBase64 = ""; }
        });

        document.getElementById('formServico').addEventListener('submit', function(e) {
            e.preventDefault(); 
            const nome = document.getElementById('inputNome').value;
            const preco = document.getElementById('inputPreco').value;
            const imagemFinal = imagemConvertidaBase64 ? imagemConvertidaBase64 : 'serv01.png';
            const novoServico = { nome: nome, preco: preco, imagem: imagemFinal };
            
            let listaServicos = JSON.parse(localStorage.getItem('meusServicos')) || [];
            listaServicos.push(novoServico);

            try {
                localStorage.setItem('meusServicos', JSON.stringify(listaServicos));
                alert('Serviço adicionado!');
                this.reset();
                imagemConvertidaBase64 = ""; 
                document.getElementById('inputImagem').value = "";
                renderizarServicosAdmin(); 
            } catch (erro) {
                alert("Imagem muito grande. Tente uma menor.");
                listaServicos.pop(); 
            }
        });

        function renderizarServicosAdmin() {
            const listaServicos = JSON.parse(localStorage.getItem('meusServicos')) || [];
            const container = document.getElementById('lista-servicos-admin');
            container.innerHTML = ''; 

            if (listaServicos.length === 0) {
                container.innerHTML = '<p class="text-center text-secondary mt-3">Nenhum serviço ativo.</p>';
                return;
            }

            listaServicos.forEach((servico, index) => {
                const imgSource = servico.imagem ? servico.imagem : 'serv01.png';
                const nomeArquivoDisplay = imgSource.startsWith('data:image') ? 'Imagem Carregada do PC' : imgSource;

                const div = document.createElement('div');
                div.className = 'service-item';
                div.innerHTML = `
                    <div class="d-flex align-items-center">
                        <img src="${imgSource}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 5px; margin-right: 10px; background: #fff;">
                        <div class="d-flex flex-column">
                            <span class="text-white fw-bold">${servico.nome}</span>
                            <span class="service-img-tag">${nomeArquivoDisplay}</span>
                        </div>
                    </div>
                    <div>
                        <span class="text-warning me-3">R$ ${parseFloat(servico.preco).toFixed(2).replace('.', ',')}</span>
                        <button class="btn-action btn-delete btn-sm" onclick="deletarServico(${index})" title="Excluir"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function deletarServico(index) {
            if(confirm("Excluir serviço?")) {
                let listaServicos = JSON.parse(localStorage.getItem('meusServicos')) || [];
                listaServicos.splice(index, 1);
                localStorage.setItem('meusServicos', JSON.stringify(listaServicos));
                renderizarServicosAdmin();
            }
        }

        function carregarPadroes() {
            if(confirm("Carregar padrões?")) {
                const padroes = [
                    { nome: "Corte Social", preco: "35.00", imagem: "serv01.png" },
                    { nome: "Barba", preco: "30.00", imagem: "serv01.png" },
                    { nome: "Sobrancelha", preco: "15.00", imagem: "serv01.png" }
                ];
                localStorage.setItem('meusServicos', JSON.stringify(padroes));
                renderizarServicosAdmin();
            }
        }

        // --- 3. HORÁRIOS ---
        function salvarHorarios() {
            localStorage.setItem('barber_abertura', document.getElementById('adminAbertura').value);
            localStorage.setItem('barber_fechamento', document.getElementById('adminFechamento').value);
            localStorage.setItem('barber_almocoIni', document.getElementById('adminAlmocoInicio').value);
            localStorage.setItem('barber_almocoFim', document.getElementById('adminAlmocoFim').value);
            alert("Horários salvos!");
        }

        // Inicialização
        window.addEventListener('load', function() {
            renderizarCalendario();
            renderizarServicosAdmin();
            
            if(localStorage.getItem('barber_abertura')) {
                document.getElementById('adminAbertura').value = localStorage.getItem('barber_abertura');
                document.getElementById('adminFechamento').value = localStorage.getItem('barber_fechamento');
                document.getElementById('adminAlmocoInicio').value = localStorage.getItem('barber_almocoIni');
                document.getElementById('adminAlmocoFim').value = localStorage.getItem('barber_almocoFim');
            }
        });
    </script>
</body>
</html>