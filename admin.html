<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T & L | Admin - Gerenciamento</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rye&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* CSS PADRÃO */
        body { background-color: #0f0f0f; background-image: repeating-linear-gradient(45deg, #0f0f0f, #0f0f0f 10px, #1a1a1a 10px, #1a1a1a 20px); color: white; min-height: 100vh; display: flex; flex-direction: column; font-family: 'Roboto Slab', serif; }
        .navbar-custom { background-color: rgba(15, 15, 15, 0.95); border-bottom: 2px solid #FFD700; padding: 15px 0; font-family: 'Rye', serif; }
        .navbar-brand { font-size: 1.5rem; color: #FFD700 !important; }
        .nav-link { color: white !important; font-size: 1.1rem; margin: 0 10px; transition: color 0.3s; }
        .nav-link:hover { color: #FFD700 !important; }
        .admin-badge { background-color: #FFD700; color: black; padding: 2px 8px; border-radius: 5px; font-size: 0.8rem; margin-left: 10px; }
        
        .page-title { font-family: 'Rye', serif; color: #FFD700; font-size: 2.5rem; text-align: center; margin: 30px 0; }
        .nav-tabs { border-bottom: 2px solid #FFD700; }
        .nav-tabs .nav-link { color: #ccc; font-family: 'Rye', serif; border: none; font-size: 1.2rem; }
        .nav-tabs .nav-link.active { background-color: #FFD700; color: black !important; border-radius: 10px 10px 0 0; }
        .tab-content { background-color: rgba(20, 20, 20, 0.9); border: 1px solid #FFD700; border-top: none; border-radius: 0 0 20px 20px; padding: 30px; min-height: 500px; }

        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; color: #FFD700; font-family: 'Rye', serif; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; text-align: center; }
        .day-name { color: #888; font-weight: bold; margin-bottom: 10px; }
        .calendar-day { background-color: #1a1a1a; border: 1px solid #444; border-radius: 10px; padding: 15px; cursor: pointer; transition: all 0.2s; position: relative; min-height: 60px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .calendar-day:hover { border-color: #FFD700; background-color: #252525; }
        .calendar-day.active { background-color: #FFD700; color: black; border-color: #FFD700; transform: scale(1.05); }
        .calendar-day.has-event::after { content: ''; position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); width: 8px; height: 8px; background-color: #ff4444; border-radius: 50%; box-shadow: 0 0 5px #ff4444; }
        .calendar-day.other-month { opacity: 0.3; pointer-events: none; }

        .appointment-card { background-color: #252525; border-left: 5px solid #FFD700; padding: 15px; margin-bottom: 15px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; transition: 0.3s; }
        .appointment-card:hover { background-color: #333; }
        .client-info h5 { color: #FFD700; margin: 0; font-family: 'Rye', serif; font-size: 1.2rem; }
        .client-info p { margin: 5px 0 0; color: #ccc; font-size: 0.9rem; }
        .client-contact { font-size: 0.8rem; color: #888; font-style: italic; }
        .btn-action { border: 1px solid white; color: white; background: transparent; border-radius: 5px; padding: 5px 10px; margin-left: 5px; transition: 0.3s; }
        .btn-action:hover { background-color: #FFD700; color: black; border-color: #FFD700; }
        .btn-delete:hover { background-color: #ff4444; border-color: #ff4444; color: white; }

        .admin-input { background-color: #1a1a1a; border: 1px solid #FFD700; border-radius: 12px; color: white; padding: 10px; width: 100%; margin-bottom: 15px; }
        .admin-btn { background-color: #FFD700; color: black; font-family: 'Rye', serif; border: none; padding: 10px 20px; border-radius: 50px; width: 100%; transition: 0.3s; }
        
        .service-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444; padding: 15px 0; }
        
        .footer { background-color: rgba(15,15,15,0.95); border-top: 2px solid #FFD700; padding: 20px 0; margin-top: auto; }
        .footer-item { display: flex; align-items: center; justify-content: center; gap: 10px; color: #fff; font-size: 14px; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-custom">
        <div class="container">
            <a class="navbar-brand" href="#">T & L Admin <span class="admin-badge">Supabase ON</span></a>
            <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="index.html">Voltar ao Site</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container flex-grow-content pb-5">
        <h1 class="page-title"><i class="fas fa-tools"></i> Painel Administrativo</h1>

        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#agenda"><i class="far fa-calendar-alt"></i> Agenda</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#servicos"><i class="fas fa-cut"></i> Serviços</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#horarios"><i class="far fa-clock"></i> Horários</button></li>
        </ul>

        <div class="tab-content" id="myTabContent">
            
            <div class="tab-pane fade show active" id="agenda">
                <div class="calendar-header">
                    <button class="btn btn-outline-warning btn-sm" onclick="mudarMes(-1)"><i class="fas fa-chevron-left"></i></button>
                    <h3 id="mesAnoTitulo">Carregando...</h3>
                    <button class="btn btn-outline-warning btn-sm" onclick="mudarMes(1)"><i class="fas fa-chevron-right"></i></button>
                </div>

                <div class="calendar-grid mb-4">
                    <div class="day-name">DOM</div><div class="day-name">SEG</div><div class="day-name">TER</div><div class="day-name">QUA</div><div class="day-name">QUI</div><div class="day-name">SEX</div><div class="day-name">SÁB</div>
                </div>
                <div id="diasCalendario" class="calendar-grid mb-4"></div>

                <hr class="border-warning my-4">
                <h4 class="text-warning mb-3 font-monospace" id="tituloListaAgendamentos">Selecione um dia</h4>
                <div id="listaAgendamentosAdmin">
                    <p class="text-muted text-center py-3">Clique em um dia no calendário para ver os horários.</p>
                </div>
            </div>

            <div class="tab-pane fade" id="servicos">
                <div class="row">
                    <div class="col-md-5 mb-4">
                        <h4 class="text-warning mb-3">Novo Serviço</h4>
                        <form id="formServico">
                            <label class="text-secondary">Nome do Serviço</label>
                            <input type="text" id="inputNome" class="admin-input" placeholder="Ex: Platinado" required>
                            <label class="text-secondary">Preço (R$)</label>
                            <input type="number" id="inputPreco" class="admin-input" placeholder="0.00" step="0.01" required>
                            <label class="text-secondary">Foto (Opcional)</label>
                            <input type="file" id="inputImagem" class="admin-input" accept="image/*">
                            <button type="submit" class="admin-btn">Salvar no Banco (Supabase)</button>
                        </form>
                    </div>
                    <div class="col-md-7">
                        <h4 class="text-warning mb-3">Serviços Ativos</h4>
                        <div id="lista-servicos-admin">
                            <p class="text-center text-secondary mt-5">Carregando do banco...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="horarios">
                <h4 class="text-warning mb-4">Configurar Funcionamento</h4>
                <div class="alert alert-info"><i class="fas fa-info-circle"></i> Os horários ainda estão salvos no computador (Local).</div>
                <div class="row">
                    <div class="col-md-6"><label class="text-secondary">Abertura</label><input type="time" id="adminAbertura" class="admin-input" value="08:00"></div>
                    <div class="col-md-6"><label class="text-secondary">Fechamento</label><input type="time" id="adminFechamento" class="admin-input" value="19:00"></div>
                    <div class="col-12 mt-3"><button class="admin-btn" onclick="salvarHorarios()">Salvar Alterações</button></div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container"><div class="row text-center"><div class="col-12"><div class="footer-item"><i class="fas fa-lock"></i><span>T & L System</span></div></div></div></div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // CONFIGURAÇÃO SUPABASE
        const SUPABASE_URL = 'https://judqyacdukuxwobxxyjg.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp1ZHF5YWNkdWt1eHdvYnh4eWpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MTI2ODEsImV4cCI6MjA4MzQ4ODY4MX0.7jc4l2GGq2SiFnLAXYd_FfmLmpoP6RFsNo_K5iKg_II';

        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- AGENDA ---
        let dataAtual = new Date();
        let mesAtual = dataAtual.getMonth();
        let anoAtual = dataAtual.getFullYear();
        let cacheAgendamentos = [];

        async function buscarAgendamentos() {
            const { data, error } = await client.from('agendamentos').select('*');
            if (error) {
                console.error("Erro Agenda:", error);
                document.getElementById('listaAgendamentosAdmin').innerHTML = '<p class="text-danger text-center">Erro ao acessar o banco.</p>';
                return;
            }
            cacheAgendamentos = data || [];
            renderizarCalendario();
        }

        function renderizarCalendario() {
            const containerDias = document.getElementById('diasCalendario');
            const meses = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            document.getElementById('mesAnoTitulo').innerText = `${meses[mesAtual]} ${anoAtual}`;
            containerDias.innerHTML = '';

            const primeiroDia = new Date(anoAtual, mesAtual, 1).getDay();
            const totalDias = new Date(anoAtual, mesAtual + 1, 0).getDate();
            
            for (let i = 0; i < primeiroDia; i++) containerDias.innerHTML += '<div class="calendar-day other-month"></div>';

            for (let dia = 1; dia <= totalDias; dia++) {
                const divDia = document.createElement('div');
                divDia.className = 'calendar-day';
                divDia.innerText = dia;
                const dataISO = `${anoAtual}-${String(mesAtual + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
                
                const temEvento = cacheAgendamentos.some(ag => ag.data === dataISO);
                if (temEvento) divDia.classList.add('has-event');

                divDia.onclick = () => {
                    document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('active'));
                    divDia.classList.add('active');
                    listarAgendamentosDoDia(dataISO, dia);
                };
                containerDias.appendChild(divDia);
            }
        }

        function listarAgendamentosDoDia(dataISO, diaNumero) {
            const container = document.getElementById('listaAgendamentosAdmin');
            const agendamentosDia = cacheAgendamentos.filter(ag => ag.data === dataISO);
            document.getElementById('tituloListaAgendamentos').innerText = `Agendamentos do dia ${diaNumero}/${mesAtual + 1}`;
            container.innerHTML = '';

            if (agendamentosDia.length === 0) {
                container.innerHTML = '<p class="text-muted text-center py-3">Sem agendamentos.</p>';
                return;
            }

            agendamentosDia.forEach(ag => {
                const div = document.createElement('div');
                div.className = 'appointment-card';
                div.innerHTML = `
                    <div class="client-info">
                        <h5>${ag.cliente}</h5>
                        <p><i class="fas fa-cut text-warning"></i> ${ag.servico} | <i class="far fa-clock text-warning"></i> ${ag.hora}</p>
                        <div class="client-contact mt-1"><i class="fab fa-whatsapp"></i> ${ag.whatsapp}</div>
                    </div>
                    <div>
                        <button class="btn-action btn-delete" onclick="deletarAgendamento(${ag.id})"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        async function deletarAgendamento(id) {
            if(confirm("Cancelar este agendamento no banco?")) {
                const { error } = await client.from('agendamentos').delete().eq('id', id);
                if(error) alert("Erro: " + error.message);
                else { alert("Agendamento cancelado!"); buscarAgendamentos(); }
            }
        }

        function mudarMes(direcao) {
            mesAtual += direcao;
            if (mesAtual < 0) { mesAtual = 11; anoAtual--; }
            else if (mesAtual > 11) { mesAtual = 0; anoAtual++; }
            renderizarCalendario();
        }

        // --- SERVIÇOS (Corrigido: 'nome_servico') ---
        let imagemBase64 = "";
        document.getElementById('inputImagem').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = (e) => imagemBase64 = e.target.result;
                reader.readAsDataURL(file);
            }
        });

        async function carregarServicos() {
            const container = document.getElementById('lista-servicos-admin');
            const { data, error } = await client.from('servico_model').select('*'); // tabela servico_model

            if(error) {
                container.innerHTML = '<p class="text-danger text-center">Erro ao conectar.</p>';
                return;
            }
            container.innerHTML = '';
            if(!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-secondary">Nenhum serviço cadastrado.</p>';
                return;
            }

            data.forEach(serv => {
                const img = serv.imagem || 'serv01.png'; // Coluna 'imagem'
                const nomeReal = serv.nome_servico; // <--- AQUI ESTAVA O ERRO (Agora é nome_servico)
                
                const div = document.createElement('div');
                div.className = 'service-item';
                div.innerHTML = `
                    <div class="d-flex align-items-center">
                        <img src="${img}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 5px; margin-right: 10px; background: #fff;">
                        <span class="text-white fw-bold">${nomeReal}</span>
                    </div>
                    <div>
                        <span class="text-warning me-3">R$ ${parseFloat(serv.preco).toFixed(2)}</span>
                        <button class="btn-action btn-delete btn-sm" onclick="deletarServico(${serv.id})"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        document.getElementById('formServico').addEventListener('submit', async function(e) {
            e.preventDefault();
            const nome = document.getElementById('inputNome').value;
            const preco = document.getElementById('inputPreco').value;
            const imagem = imagemBase64 || ''; 

            // AQUI TAMBÉM: Enviando como 'nome_servico'
            const { error } = await client.from('servico_model').insert([{ 
                nome_servico: nome, 
                preco: preco, 
                imagem: imagem 
            }]);

            if(error) alert("Erro ao salvar: " + error.message);
            else { 
                alert("Serviço salvo no Supabase!"); 
                this.reset(); 
                carregarServicos(); 
            }
        });

        async function deletarServico(id) {
            if(confirm("Excluir este serviço?")) {
                const { error } = await client.from('servico_model').delete().eq('id', id);
                if(error) alert("Erro: " + error.message);
                else carregarServicos();
            }
        }

        function salvarHorarios() {
            localStorage.setItem('barber_abertura', document.getElementById('adminAbertura').value);
            localStorage.setItem('barber_fechamento', document.getElementById('adminFechamento').value);
            alert("Horários salvos localmente!");
        }

        window.onload = function() {
            buscarAgendamentos();
            carregarServicos();
            if(localStorage.getItem('barber_abertura')) {
                document.getElementById('adminAbertura').value = localStorage.getItem('barber_abertura');
                document.getElementById('adminFechamento').value = localStorage.getItem('barber_fechamento');
            }
        };
    </script>
</body>
</html>