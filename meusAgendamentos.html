<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T & L | Meus Agendamentos</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rye&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* CSS IGUAL AO SEU */
        body { background-color: #0f0f0f; background-image: repeating-linear-gradient(45deg, #0f0f0f, #0f0f0f 10px, #1a1a1a 10px, #1a1a1a 20px); color: white; min-height: 100vh; display: flex; flex-direction: column; font-family: 'Roboto Slab', serif; }
        .navbar-custom { background-color: rgba(15, 15, 15, 0.95); border-bottom: 2px solid #FFD700; padding: 15px 0; font-family: 'Rye', serif; }
        .navbar-brand { font-size: 1.5rem; color: #FFD700 !important; }
        .nav-link { color: white !important; font-size: 1.1rem; margin: 0 10px; transition: color 0.3s; }
        .nav-link:hover, .nav-link.active { color: #FFD700 !important; }
        
        .appointment-item { border: 2px solid white; border-radius: 20px; padding: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; background-color: rgba(0,0,0,0.5); }
        .status-PENDENTE { border-color: white; }
        .status-FINALIZADO { border-color: #198754; opacity: 0.8; }
        .status-CANCELADO { border-color: #dc3545; opacity: 0.6; }

        .appointment-text { color: #FFD700; font-family: 'Roboto Slab', serif; font-weight: bold; font-style: italic; font-size: 1.2rem; }
        .btn-delete { background: none; border: 1px solid #ff4444; color: #ff4444; padding: 5px 10px; border-radius: 50%; cursor: pointer; }
        .btn-delete:hover { background-color: #ff4444; color: white; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-custom">
        <div class="container">
            <a class="navbar-brand" href="index.html">T & L | BarberShop</a>
            <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="index.html">Início</a></li>
                    <li class="nav-item"><a class="nav-link" href="agendamento.html">Agendamento</a></li>
                    <li class="nav-item"><a class="nav-link active" href="#">Meus Agendamentos</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="sair()">Sair</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-5 flex-grow-1">
        <h1 class="text-center" style="font-family: 'Rye', serif; color: #FFD700; font-size: 3rem;">Meus Agendamentos</h1>
        <p class="text-center text-secondary mb-5">Histórico de: <strong id="nomeCliente" style="color: white;">...</strong></p>

        <div id="listaAgendamentos" style="max-width: 800px; margin: 0 auto;">
            <p class="text-center">Carregando...</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- 1. BLOQUEIO DE SEGURANÇA (O GUARDA) ---
        // Se não tiver CPF salvo, manda voltar pro login AGORA.
        const cpfLogado = localStorage.getItem("clienteLogadoCPF");
        const nomeLogado = localStorage.getItem("clienteNome");

        if (!cpfLogado) {
            alert("Acesso Negado! Faça login primeiro.");
            window.location.href = "login.html"; // Redireciona
        } else {
            // Se tiver logado, mostra o nome na tela
            if(nomeLogado) document.getElementById('nomeCliente').innerText = nomeLogado;
        }

        // --- 2. CONFIGURAÇÃO DO BANCO ---
        const SUPABASE_URL = 'https://judqyacdukuxwobxxyjg.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp1ZHF5YWNkdWt1eHdvYnh4eWpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MTI2ODEsImV4cCI6MjA4MzQ4ODY4MX0.7jc4l2GGq2SiFnLAXYd_FfmLmpoP6RFsNo_K5iKg_II';
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        window.onload = carregarAgendamentos;

        async function carregarAgendamentos() {
            const container = document.getElementById('listaAgendamentos');

            // A. Busca ID do cliente usando o CPF salvo
            const { data: cliente } = await client
                .from('cliente_model')
                .select('id')
                .eq('cpf', cpfLogado)
                .single();

            if (!cliente) {
                container.innerHTML = "<p class='text-center'>Erro: Cliente não identificado.</p>";
                return;
            }

            // B. Busca os agendamentos desse ID
            const { data: agendamentos, error } = await client
                .from('agendamentos')
                .select(`
                    id, data, horario, status_agendamento,
                    agendamento_servicos (
                        servico_model ( nome_servico )
                    )
                `)
                .eq('cliente_id', cliente.id)
                .order('data', { ascending: false }); // Mais recentes primeiro

            if (error) { console.error(error); return; }

            // C. Mostra na tela
            container.innerHTML = "";
            if (!agendamentos || agendamentos.length === 0) {
                container.innerHTML = "<h4 class='text-center text-secondary'>Nenhum agendamento encontrado.</h4>";
                return;
            }

            agendamentos.forEach(ag => {
                const dataFormatada = ag.data.split('-').reverse().join('/');
                const horaFormatada = ag.horario.slice(0, 5);
                const status = ag.status_agendamento || 'PENDENTE';
                
                // Pega os nomes dos serviços
                let servicos = "Serviço";
                if (ag.agendamento_servicos && ag.agendamento_servicos.length > 0) {
                    servicos = ag.agendamento_servicos.map(s => s.servico_model?.nome_servico).join(" + ");
                }

                // Botão de Cancelar
                let btnCancel = "";
                if (status === 'PENDENTE') {
                    btnCancel = `<button class="btn-delete" onclick="cancelar(${ag.id})"><i class="fas fa-trash"></i></button>`;
                }

                container.innerHTML += `
                    <div class="appointment-item status-${status}">
                        <div>
                            <div class="appointment-text">${servicos}</div>
                            <div class="text-secondary small mt-1">
                                <i class="fas fa-calendar"></i> ${dataFormatada} às ${horaFormatada} - ${status}
                            </div>
                        </div>
                        ${btnCancel}
                    </div>
                `;
            });
        }

        async function cancelar(id) {
            if(!confirm("Cancelar este horário?")) return;
            await client.from('agendamentos').update({ status_agendamento: 'CANCELADO' }).eq('id', id);
            alert("Cancelado!");
            carregarAgendamentos();
        }

        function sair() {
            localStorage.clear(); // Limpa o login
            window.location.href = "login.html"; // Manda de volta pro login
        }
    </script>
</body>
</html>